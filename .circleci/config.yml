version: 2.1

orbs:
  ggshield: gitguardian/ggshield@volatile
  browser-tools: circleci/browser-tools@1.5.3
  sonarcloud: sonarsource/sonarcloud@3.0.1
  doppler: conpago/doppler@1.3.5

jobs:
  build:
    docker:
      - image: cimg/node:current
    steps:
      - checkout:
          method: blobless
      - restore_cache:
          name: Restore node_modules and next cache
          keys:
            # when lock file changes, use increasingly general patterns to restore cache
            - node-v6-fresh-{{ .Branch }}-{{ checksum "webapp/package-lock.json" }}
            - node-v6-fresh-{{ .Branch }}-
            - node-v6-fresh-
      - restore_cache:
          name: Restore Playwright cache
          keys:
            - playwright-{{ .Branch }}-{{ checksum "webapp/package-lock.json" }}
            - playwright-{{ .Branch }}-
            - playwright-
      - run:
          name: Install modules
          command: |
            cd webapp
            # Clear any existing corrupted installation
            rm -rf node_modules package-lock.json
            # Install dependencies with optimized rollup installation
            npm install
            # Install rollup and native module in one step
            npm install rollup @rollup/rollup-linux-x64-gnu --force
      - run:
          name: Install Playwright Chromium (if not cached)
          command: |
            cd webapp && npx playwright install --with-deps chromium
      - save_cache:
          name: Cache Playwright
          paths:
            - ~/.cache/ms-playwright
          key: playwright-{{ .Branch }}-{{ checksum "webapp/package-lock.json" }}
      - doppler/install
      - run:
          name: Setup Wrangler configuration
          command: |
            cd webapp && ./scripts/setup-wrangler-config.sh

      - run:
          name: Build app
          command: |
            cd webapp && npm run build
      - save_cache:
          name: Update node_modules cache
          paths:
            - webapp/node_modules
          key: node-v6-fresh-{{ .Branch }}-{{ checksum "webapp/package-lock.json" }}
      - persist_to_workspace:
          root: webapp
          paths:
            - .svelte-kit

  code_test:
    docker:
      - image: cimg/node:current
    resource_class: large # Increase to large for more memory and CPU resources
    steps:
      - checkout:
          method: blobless
      - restore_cache:
          name: Restore node_modules
          keys:
            # when lock file changes, use increasingly general patterns to restore cache
            - node-v6-fresh-{{ .Branch }}-{{ checksum "webapp/package-lock.json" }}
            - node-v6-fresh-{{ .Branch }}-
            - node-v6-fresh-
      - attach_workspace:
          at: webapp
      - doppler/install
      - run:
          name: Setup Wrangler configuration
          command: |
            cd webapp && ./scripts/setup-wrangler-config.sh
      - run:
          name: Start tests in background
          command: |
            cd webapp
            rm -f /tmp/test_exit_code
            rm -f /tmp/test_runner_pid
            mkdir -p reports
            mkdir -p coverage
            # Pre-create coverage file so SonarCloud scanner finds the expected path
            echo "TN:" > coverage/lcov.info
            export JEST_JUNIT_OUTPUT_DIR=./reports/
            nohup bash -c 'NODE_OPTIONS="--max-old-space-size=4096" npm run test-ci; echo $? > /tmp/test_exit_code' > reports/test-ci.log 2>&1 &
            echo $! > /tmp/test_runner_pid
          background: true
      - sonarcloud/scan
      - run:
          name: Wait for tests to finish
          command: |
            set -e
            cd webapp
            TEST_PID_FILE=/tmp/test_runner_pid
            EXIT_FILE=/tmp/test_exit_code
            if [ ! -f "$TEST_PID_FILE" ]; then
              echo "Test PID file not found"
              exit 1
            fi
            TEST_PID=$(cat "$TEST_PID_FILE")
            echo "Waiting for test process PID $TEST_PID to complete..."
            # Poll until the exit code file is written by the background process
            while [ ! -f "$EXIT_FILE" ]; do
              if ! kill -0 "$TEST_PID" 2>/dev/null; then
                echo "Test process appears to have exited but no exit code recorded yet."
                break
              fi
              sleep 5
            done
            if [ ! -f "$EXIT_FILE" ]; then
              echo "Test exit code file not found; failing job."
              exit 1
            fi
            TEST_EXIT=$(cat "$EXIT_FILE")
            if [ "$TEST_EXIT" -ne 0 ]; then
              echo "Tests failed with exit code $TEST_EXIT"
              exit "$TEST_EXIT"
            fi
            echo "Tests completed successfully."
      - run:
          name: Check memory usage
          command: |
            echo "Memory usage after tests:"
            free -h
            echo "Disk usage:"
            df -h
          when: always
      - store_test_results:
          path: ./webapp/reports/

  browser_test:
    environment:
      SENTRY_ORG: nick-brett
      SENTRY_PROJECT: bem-backend
      SENTRY_ENVIRONMENT: staging
      SENTRY_RELEASE: << pipeline.git.revision >>
      LIGHTHOUSE_ENABLED: "true"
    docker:
      - image: cimg/node:current-browsers
    steps:
      - run: sudo apt-get update
      - browser-tools/install-chrome:
          replace-existing: true
      - browser-tools/install-chromedriver
      - restore_cache:
          name: Restore Lighthouse CLI cache
          keys:
            - lighthouse-cli-{{ .Branch }}-
            - lighthouse-cli-
      - checkout:
          method: blobless
      - restore_cache:
          name: Restore node_modules and next cache
          keys:
            # when lock file changes, use increasingly general patterns to restore cache
            - node-v6-fresh-{{ .Branch }}-{{ checksum "webapp/package-lock.json" }}
            - node-v6-fresh-{{ .Branch }}-
            - node-v6-fresh-
      - attach_workspace:
          at: webapp
      - doppler/install
      - run:
          name: Setup Wrangler configuration
          command: |
            cd webapp && ./scripts/setup-wrangler-config.sh

      - run:
          name: Install Lighthouse CLI (if not cached)
          command: |
            sudo npm install -g @lhci/cli@0.9.x
      - save_cache:
          name: Cache Lighthouse CLI
          paths:
            - /usr/local/lib/node_modules/@lhci
          key: lighthouse-cli-{{ .Branch }}-
      - run:
          name: Run Lighthouse checks
          command: |
            cd webapp && npm run lighthouse-staging

  deploy:
    environment:
      SENTRY_ORG: nick-brett
      SENTRY_PROJECT: bem-backend
      SENTRY_ENVIRONMENT: production
      SENTRY_RELEASE: << pipeline.git.revision >>
    docker:
      - image: cimg/node:current
    steps:
      - checkout:
          method: blobless
      - restore_cache:
          name: Restore node_modules
          keys:
            # when lock file changes, use increasingly general patterns to restore cache
            - node-v6-fresh-{{ .Branch }}-{{ checksum "webapp/package-lock.json" }}
            - node-v6-fresh-{{ .Branch }}-
            - node-v6-fresh-
      - attach_workspace:
          at: webapp
      - doppler/install
      - run:
          name: Setup Wrangler configuration
          command: |
            cd webapp && ./scripts/setup-wrangler-config.sh

      - run:
          name: Install jq
          command: |
            sudo apt-get update && sudo apt-get install -y jq
      - run:
          name: Sync Doppler secrets to Cloudflare (production)
          command: |
            cd webapp
            echo "Attempting to sync secrets to Cloudflare production environment..."
            if doppler secrets --json | jq -c 'with_entries(.value = .value.computed)' | npx wrangler secret bulk --env production; then
              echo "✅ Secrets successfully synced to Cloudflare production"
            else
              echo "❌ Error: Failed to sync secrets to Cloudflare production. This is critical for production deployments."
              exit 1
            fi
      - run:
          name: Deploying to Cloudflare
          command: |
            cd webapp
            npm run deploy

  deploy-preview:
    environment:
      SENTRY_ORG: nick-brett
      SENTRY_PROJECT: bem-backend
      SENTRY_ENVIRONMENT: preview
      SENTRY_RELEASE: << pipeline.git.revision >>
    docker:
      - image: cimg/node:current
    steps:
      - checkout:
          method: blobless
      - restore_cache:
          name: Restore node_modules
          keys:
            # when lock file changes, use increasingly general patterns to restore cache
            - node-v6-fresh-{{ .Branch }}-{{ checksum "webapp/package-lock.json" }}
            - node-v6-fresh-{{ .Branch }}-
            - node-v6-fresh-
      - attach_workspace:
          at: webapp
      - doppler/install
      - run:
          name: Setup Wrangler configuration
          command: |
            cd webapp && ./scripts/setup-wrangler-config.sh

      - run:
          name: Install jq
          command: |
            sudo apt-get update && sudo apt-get install -y jq
      - run:
          name: Sync Doppler secrets to Cloudflare (preview)
          command: |
            cd webapp
            echo "Attempting to sync secrets to Cloudflare preview environment..."
            if doppler secrets --json | jq -c 'with_entries(.value = .value.computed)' | npx wrangler secret bulk --env preview; then
              echo "✅ Secrets successfully synced to Cloudflare preview"
            else
              echo "⚠️  Warning: Failed to sync secrets to Cloudflare preview. This may be due to script settings conflicts."
              echo "Continuing with deployment as this is not critical for preview environments..."
            fi
      - run:
          name: Deploying preview to Cloudflare
          command: |
            cd webapp
            npm run deploy-preview

workflows:
  build_test_deploy:
    jobs:
      - ggshield/scan:
          name: ggshield-scan
          base_revision: << pipeline.git.base_revision >>
          revision: <<pipeline.git.revision>>
      - build
      - code_test:
          requires:
            - build
      - browser_test:
          requires:
            - build
      - deploy:
          requires:
            - browser_test
            - code_test
          filters:
            branches:
              only: main
      - deploy-preview:
          requires:
            - browser_test
            - code_test
          filters:
            branches:
              ignore: main
