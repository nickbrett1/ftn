name: Cleanup Preview Environments

on:
  delete:
    branches:
      - '**'  # Trigger on any branch deletion

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to check deleted branches
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webapp/package-lock.json
      
      - name: Install dependencies
        run: |
          cd webapp
          npm ci
      
      - name: Install Wrangler
        run: |
          cd webapp
          npm install -g wrangler
      
      - name: Setup Wrangler authentication
        run: |
          cd webapp
          echo "${{ secrets.CLOUDFLARE_API_TOKEN }}" | wrangler login
      
      - name: Cleanup deleted branch environments
        run: |
          cd webapp
          # Get the name of the deleted branch
          DELETED_BRANCH="${{ github.event.ref_name }}"
          
          # Sanitize branch name for environment lookup
          SANITIZED_BRANCH=$(echo "$DELETED_BRANCH" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
          ENV_NAME="preview-${SANITIZED_BRANCH}"
          
          echo "ðŸ—‘ï¸ Cleaning up environment for deleted branch: $DELETED_BRANCH"
          echo "ðŸ” Looking for environment: $ENV_NAME"
          
          # Try to remove the environment
          if npx wrangler env delete --env "$ENV_NAME" --yes 2>/dev/null; then
            echo "âœ… Successfully removed environment: $ENV_NAME"
          else
            echo "â„¹ï¸ Environment $ENV_NAME not found or already removed"
          fi
      
      - name: List remaining preview environments
        run: |
          cd webapp
          echo "ðŸ“‹ Remaining preview environments:"
          npx wrangler env list 2>/dev/null | grep "preview-" || echo "No preview environments found"
      
      - name: Cleanup orphaned environments
        run: |
          cd webapp
          echo "ðŸ§¹ Running cleanup script..."
          ./cleanup-preview-environments.sh cleanup